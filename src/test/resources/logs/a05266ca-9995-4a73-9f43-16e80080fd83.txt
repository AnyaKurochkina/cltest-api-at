[{created_row_dt=2021-07-05T14:06:24.433817+03:00, create_dt=2021-07-05T14:06:24.433837+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=09614aee-7fe4-4825-99bd-cb8032152502, type=deploy, subtype=rollback, status=completed, data=null}, {created_row_dt=2021-07-05T14:06:24.396563+03:00, create_dt=2021-07-05T14:06:24.396582+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=rollback_node, status=/request_resources_0/gen_hostname:completed, data={success=true}}, {created_row_dt=2021-07-05T14:06:24.346539+03:00, create_dt=2021-07-05T14:06:24.346552+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=rollback_node, status=/request_resources_0/gen_hostname:started, data={_id=11ac078b-0513-4e55-b325-1990317d5825, role=generic_application, _name=/request_resources_0/gen_hostname, _type=rollback_node, is_code=crux, os_type=linux, hostname=dxcrux-apc001lv, _template=naming, env_prefix=dx, environment=DEV, product_type=vm, virtual_platform=vmware}}, {created_row_dt=2021-07-05T14:06:24.310515+03:00, create_dt=2021-07-05T14:06:24.310529+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=rollback_node, status=/request_resources_0/get_net_info:completed, data={success=true}}, {created_row_dt=2021-07-05T14:06:24.079167+03:00, create_dt=2021-07-05T14:06:24.079181+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=rollback_node, status=/request_resources_0/get_net_info:started, data={_id=11ac078b-0513-4e55-b325-1990317d5825, site=K37, _name=/request_resources_0/get_net_info, _type=rollback_node, cluster=K37-5-SOUL, hostname=dxcrux-apc001lv, platform=vmware, _template=ipam, extra_nics=[], default_nic={subnet={name=dvpg_K37-5-SOUL_1356, uuid=dvportgroup-1065}, default=true, addresses=[{type=ipv4, ip_id=101181, address=10.226.3.66, bitmask=25, netmask=255.255.255.128, default_gw=10.226.3.1}], nameservers=[10.230.192.45, 10.203.192.77, 10.230.192.46, 10.203.192.78], net_segment=dev-srv-app, address_assignment=STATIC}, business_line=general}}, {created_row_dt=2021-07-05T14:06:24.038951+03:00, create_dt=2021-07-05T14:06:24.038966+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=09614aee-7fe4-4825-99bd-cb8032152502, type=deploy, subtype=rollback_node, status=turn_off_monitoring_0:completed, data={}}, {created_row_dt=2021-07-05T14:06:23.082689+03:00, create_dt=2021-07-05T14:06:23.082709+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=09614aee-7fe4-4825-99bd-cb8032152502, type=deploy, subtype=rollback_node, status=turn_off_monitoring_0:started, data={_id=77405002-d213-4a27-ba9c-97b7cc7d0253, _name=turn_off_monitoring_0, _type=rollback_node, domain=corp.dev.vtb, hostname=dxcrux-apc001lv, _template=delete_host}}, {created_row_dt=2021-07-05T14:06:23.037370+03:00, create_dt=2021-07-05T14:06:23.037388+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=09614aee-7fe4-4825-99bd-cb8032152502, type=deploy, subtype=rollback, status=started, data=null}, {created_row_dt=2021-07-05T14:06:23.025420+03:00, create_dt=2021-07-05T14:06:23.025436+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=09614aee-7fe4-4825-99bd-cb8032152502, type=billing, subtype=folder, status=changed, data={folder=/organization/vtb/folder/fold-4rvl35gw52/folder/fold-6vixrmqew3/folder/fold-nqa7hl8cug/project/proj-frk0ux52hp/, account_id=c1cdd49a-eed5-4f59-a41f-3a0585149012}}, {created_row_dt=2021-07-05T14:06:22.997693+03:00, create_dt=2021-07-05T14:06:22.997712+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=7fd73b08-6ea4-4ef9-aec0-6df840a1167f, type=deploy, subtype=run, status=error, data={path=/create_vms_0, error=a05266ca-9995-4a73-9f43-16e80080fd83: Error in node create_vm run_node: 400, message='Unhandled message', url=URL('https://d5soul-vc5001xv.region.vtb.ru/rest/vcenter/vm-template/library-items/9126fee2-6395-44eb-927e-2dfcd0fe0537?action=deploy'), traceback=Traceback (most recent call last):
  File "/opt/project/app/graph.py", line 520, in run
    await coro
  File "/usr/local/lib/python3.8/asyncio/tasks.py", line 616, in _wait_for_one
    return f.result()  # May raise f.exception().
  File "/opt/project/app/graph.py", line 484, in _run_node
    await node.run(self.params)
  File "/opt/project/app/graph.py", line 287, in run
    raise RPCException(
app.mq.RPCException: a05266ca-9995-4a73-9f43-16e80080fd83: Error in node create_vm run_node: 400, message='Unhandled message', url=URL('https://d5soul-vc5001xv.region.vtb.ru/rest/vcenter/vm-template/library-items/9126fee2-6395-44eb-927e-2dfcd0fe0537?action=deploy')
}}, {created_row_dt=2021-07-05T14:06:22.958315+03:00, create_dt=2021-07-05T14:06:22.958334+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=7fd73b08-6ea4-4ef9-aec0-6df840a1167f, type=deploy, subtype=run_node, status=/create_vms_0/create_vm:error, data={error=400, message='Unhandled message', url=URL('https://d5soul-vc5001xv.region.vtb.ru/rest/vcenter/vm-template/library-items/9126fee2-6395-44eb-927e-2dfcd0fe0537?action=deploy'), traceback=Traceback (most recent call last):
  File "/usr/local/lib/python3.8/site-packages/state_service_utils/utils.py", line 94, in wrapper
    result = await func(
  File "cloud_mate.py", line 32, in task
    result = await execution_handler(kwargs)
  File "/opt/cloud_mate/app/api.py", line 59, in wrapper
    result = await wait_for(func(inputs), timeout=settings.TASK_EXECUTION_TIMEOUT)
  File "/usr/local/lib/python3.8/asyncio/tasks.py", line 491, in wait_for
    return fut.result()
  File "/opt/cloud_mate/plugins/vsphere/adapter.py", line 27, in execute
    return await self.interface(client, **inputs)
  File "/opt/cloud_mate/plugins/vsphere/client.py", line 232, in create_vm
    vm_id = await self.restclient.vmt.create_vm(
  File "/opt/cloud_mate/aiovspheresdk/rest/vm_template.py", line 22, in create_vm
    response = await self.client.post(endpoint, body)
  File "/opt/cloud_mate/aiovspheresdk/rest/client.py", line 73, in post
    return await self.response_handler(response)
  File "/opt/cloud_mate/aiovspheresdk/rest/client.py", line 64, in response_handler
    raise ClientResponseError(
aiohttp.client_exceptions.ClientResponseError: 400, message='Unhandled message', url=URL('https://d5soul-vc5001xv.region.vtb.ru/rest/vcenter/vm-template/library-items/9126fee2-6395-44eb-927e-2dfcd0fe0537?action=deploy')
}}, {created_row_dt=2021-07-05T14:06:19.957930+03:00, create_dt=2021-07-05T14:06:19.957943+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=7fd73b08-6ea4-4ef9-aec0-6df840a1167f, type=deploy, subtype=run_node, status=/create_vms_0/create_vm:started, data={_id=79289b19-ecf1-469e-bf5a-41ead1d02b93, _name=/create_vms_0/create_vm, _type=run_node, image={os={type=linux, vendor=ibm, version=8.latest, architecture=x86_64, distribution=rhel, localization=en}, name=cloud_linux_rhel_8.latest_x86_64_en, size=30, uuid=e5463492-a277-4cd8-b89b-00d1b10f6f52}, flavor={cpus=1, name=c1m1, uuid=d46ef6b2-1d14-472b-990b-82a124de309c, memory=1}, tenant={name=Cloud-dxcrux, uuid=group-v1393}, sysprep=, hostname=dxcrux-apc001lv, _template=create_vm, boot_disk={size=30}, user_data=#!/bin/bash
hostnamectl set-hostname dxcrux-apc001lv.corp.dev.vtb
useradd -d /home/vtbcloud-config-mgmt -m -s /bin/bash -c 'VTB.Cloud' vtbcloud-config-mgmt
usermod -p '$6$nKmHXBeW$9ofdJ10v2iLPQ9wGn3bJZ7/8cKOjauGnJiM/kBYQA2qtHc.zhQofDTBXfHpUxvTnF/S1F6ukrURqzPD5mHYlP0' vtbcloud-config-mgmt
echo -e 'vtbcloud-config-mgmt\tALL=(ALL) \tNOPASSWD: ALL' > /etc/sudoers.d/vtbcloud-config-mgmt
chmod 600 /etc/sudoers.d/vtbcloud-config-mgmt
, extra_nics=[], default_nic={subnet={name=dvpg_K37-5-SOUL_1356, uuid=dvportgroup-1065}, default=true, addresses=[{type=ipv4, ip_id=101181, address=10.226.3.66, bitmask=25, netmask=255.255.255.128, default_gw=10.226.3.1}], nameservers=[10.230.192.45, 10.203.192.77, 10.230.192.46, 10.203.192.78], net_segment=dev-srv-app, address_assignment=STATIC}, extra_disks=[{size=10}], resource_pool={name=K37-5-SOUL, uuid=domain-c23, endpoint=https://d5soul-vc5001xv.region.vtb.ru, platform=vsphere, tenant_prefix=Cloud}}}, {created_row_dt=2021-07-05T14:06:19.912067+03:00, create_dt=2021-07-05T14:06:19.912081+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=7fd73b08-6ea4-4ef9-aec0-6df840a1167f, type=deploy, subtype=run, status=started, data={image={os={type=linux, vendor=ibm, version=8.latest, architecture=x86_64, distribution=rhel, localization=en}, name=cloud_linux_rhel_8.latest_x86_64_en, size=30, uuid=e5463492-a277-4cd8-b89b-00d1b10f6f52}, domain=corp.dev.vtb, flavor={cpus=1, name=c1m1, uuid=d46ef6b2-1d14-472b-990b-82a124de309c, memory=1}, rrtype=[A, PTR], tenant={name=Cloud-dxcrux, uuid=group-v1393}, sysprep=, hostname=dxcrux-apc001lv, boot_disk={size=30}, user_data=#!/bin/bash
hostnamectl set-hostname dxcrux-apc001lv.corp.dev.vtb
useradd -d /home/vtbcloud-config-mgmt -m -s /bin/bash -c 'VTB.Cloud' vtbcloud-config-mgmt
usermod -p '$6$nKmHXBeW$9ofdJ10v2iLPQ9wGn3bJZ7/8cKOjauGnJiM/kBYQA2qtHc.zhQofDTBXfHpUxvTnF/S1F6ukrURqzPD5mHYlP0' vtbcloud-config-mgmt
echo -e 'vtbcloud-config-mgmt\tALL=(ALL) \tNOPASSWD: ALL' > /etc/sudoers.d/vtbcloud-config-mgmt
chmod 600 /etc/sudoers.d/vtbcloud-config-mgmt
, extra_nics=[], on_support=true, default_nic={subnet={name=dvpg_K37-5-SOUL_1356, uuid=dvportgroup-1065}, default=true, addresses=[{type=ipv4, ip_id=101181, address=10.226.3.66, bitmask=25, netmask=255.255.255.128, default_gw=10.226.3.1}], nameservers=[10.230.192.45, 10.203.192.77, 10.230.192.46, 10.203.192.78], net_segment=dev-srv-app, address_assignment=STATIC}, environment=DEV, extra_disks=[{size=10}], resource_pool={name=K37-5-SOUL, uuid=domain-c23, endpoint=https://d5soul-vc5001xv.region.vtb.ru, platform=vsphere, tenant_prefix=Cloud}, ad_integration=true, environment_type=DEV}}, {created_row_dt=2021-07-05T14:06:19.797288+03:00, create_dt=2021-07-05T14:06:19.797300+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=run_node, status=/request_resources_0/get_net_info:completed, data={extra_nics=[], default_nic={subnet={name=dvpg_K37-5-SOUL_1356, uuid=dvportgroup-1065}, default=true, addresses=[{type=ipv4, ip_id=101181, address=10.226.3.66, bitmask=25, netmask=255.255.255.128, default_gw=10.226.3.1}], nameservers=[10.230.192.45, 10.203.192.77, 10.230.192.46, 10.203.192.78], net_segment=dev-srv-app, address_assignment=STATIC}}}, {created_row_dt=2021-07-05T14:06:19.229425+03:00, create_dt=2021-07-05T14:06:19.229440+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=run_node, status=/request_resources_0/get_net_info:started, data={_id=11ac078b-0513-4e55-b325-1990317d5825, site=K37, _name=/request_resources_0/get_net_info, _type=run_node, cluster=K37-5-SOUL, hostname=dxcrux-apc001lv, platform=vmware, _template=ipam, extra_nics=[], default_nic={net_segment=dev-srv-app}, business_line=general}}, {created_row_dt=2021-07-05T14:06:19.186644+03:00, create_dt=2021-07-05T14:06:19.186658+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=run_node, status=/request_resources_0/gen_hostname:completed, data={hostname=dxcrux-apc001lv}}, {created_row_dt=2021-07-05T14:06:19.103859+03:00, create_dt=2021-07-05T14:06:19.103873+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=run_node, status=/request_resources_0/gen_hostname:started, data={_id=11ac078b-0513-4e55-b325-1990317d5825, role=generic_application, _name=/request_resources_0/gen_hostname, _type=run_node, is_code=crux, os_type=linux, _template=naming, env_prefix=dx, environment=DEV, product_type=vm, virtual_platform=vmware}}, {created_row_dt=2021-07-05T14:06:19.061375+03:00, create_dt=2021-07-05T14:06:19.061390+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=b8e662c8-73d3-4209-8b1c-cb3a894271d7, type=deploy, subtype=run, status=started, data={role=generic_application, image={os={type=linux, vendor=ibm, version=8.latest, architecture=x86_64, distribution=rhel, localization=en}, name=cloud_linux_rhel_8.latest_x86_64_en, size=30, uuid=e5463492-a277-4cd8-b89b-00d1b10f6f52}, tenant={name=Cloud-dxcrux, uuid=group-v1393}, is_code=crux, platform={vcloud=vmware, cluster=cluster, nutanix=nutanix, vsphere=vmware, openstack=openstack, physical_server=physical_server}, env_prefix=dx, extra_nics=[], data_center={code=5, name=K37}, default_nic={net_segment=dev-srv-app}, environment=DEV, product_type=vm, business_line=general, resource_pool={name=K37-5-SOUL, uuid=domain-c23, endpoint=https://d5soul-vc5001xv.region.vtb.ru, platform=vsphere, tenant_prefix=Cloud}}}, {created_row_dt=2021-07-05T14:06:18.984834+03:00, create_dt=2021-07-05T14:06:18.984846+03:00, order_id=a05266ca-9995-4a73-9f43-16e80080fd83, action_id=3cb30781-a1a7-4d50-9d22-00f7dfef689b, graph_id=09614aee-7fe4-4825-99bd-cb8032152502, type=deploy, subtype=run, status=started, data={role=generic_application, image={os={type=linux, vendor=ibm, version=8.latest, architecture=x86_64, distribution=rhel, localization=en}, name=cloud_linux_rhel_8.latest_x86_64_en, size=30, uuid=e5463492-a277-4cd8-b89b-00d1b10f6f52}, domain=corp.dev.vtb, flavor={cpus=1, name=c1m1, uuid=d46ef6b2-1d14-472b-990b-82a124de309c, memory=1}, ris_id=1, tenant={name=Cloud-dxcrux, uuid=group-v1393}, is_code=crux, code_apd=86.54.33, platform=vSphere, quantity=1, boot_disk={size=30}, credential=VTB.Cloud-DEV, env_prefix=dx, extra_nics=[], on_support=true, os_version=8.latest, prime_user=vtbcloud-config-mgmt, data_center={code=5, name=K37}, default_nic={net_segment=dev-srv-app}, environment=DEV, extra_disks=[], extra_mounts=[{path=/app, size=10, file_system=xfs}], product_type=vm, business_line=general, resource_pool={name=K37-5-SOUL, uuid=domain-c23, endpoint=https://d5soul-vc5001xv.region.vtb.ru, platform=vsphere, tenant_prefix=Cloud}, ad_integration=true, os_local_users=[], ad_logon_grants=[{role=superuser, groups=[cloud-dbcrux-testgrop]}], environment_type=DEV, inventory_template={% set inventory = {'all': {'hosts': {}}} %}{% for entity in entities %}{% set _ = inventory.all.hosts.update({entity.config.hostname + '.' + entity.config.domain: {'ansible_host': entity.config.default_v4_address, 'extra_mounts': extra_mounts, 'os_local_users': os_local_users | default([]), 'ad_logon_grants': ad_logon_grants | default([]), 'entity': entity}}) %}{% endfor %}{{ inventory | tojson }}, user_data_template={% macro add_address_prefix(addr_conf_list) -%}
  {%- set addresses = [] -%}
  {%- for addr_conf in addr_conf_list -%}
    {% set _ = addresses.append(addr_conf.address + '/' + addr_conf.bitmask) %}
  {%- endfor -%}
  {{ addresses | join(',') }}
{%- endmacro -%}

{%- macro make_userdata(platform, hostname, domain, prime_user, prime_user_description, prime_user_init_passwd, default_nic) -%}
#!/bin/bash
hostnamectl set-hostname {{ hostname }}.{{ domain }}
useradd -d /home/{{ prime_user }} -m -s /bin/bash -c '{{ prime_user_description }}' {{ prime_user }}
usermod -p '{{ prime_user_init_passwd | b64decode }}' {{ prime_user }}
echo -e '{{ prime_user }}\tALL=(ALL) \tNOPASSWD: ALL' > /etc/sudoers.d/{{ prime_user }}
chmod 600 /etc/sudoers.d/{{ prime_user }}
{% if default_nic.address_assignment == 'STATIC' and platform | lower not in ['vsphere', 'vcloud'] -%}
nic_uuid=$(nmcli -g uuid connection show)
nic_device=$(nmcli -g device connection show)
nmcli device disconnect $nic_device
nmcli connection modify $nic_uuid ipv4.method manual ipv4.addresses {{ add_address_prefix(default_nic.addresses) }} ipv4.gateway {{ default_nic.addresses | map(attribute='default_gw') | list | first }} ipv4.dns {{ default_nic.nameservers | join(',') }} ipv4.dns-search {{ domain }}
nmcli device connect $nic_device
{% endif %}
{%- endmacro -%}

{%- for machine in machines -%}
{% set _ = machine.update({'user_data': make_userdata(platform, machine.hostname, domain, prime_user, prime_user_description, prime_user_init_passwd, machine.default_nic)}) %}
{%- endfor -%}
{{- machines | tojson }}, extra_disks_template={% set max_size = 2048 %}{% set extra_disks = [] %}{% set total_size = extra_mounts | map(attribute='size')| list | sum %}{% set count = total_size // max_size %}{% set modulo = total_size % max_size %}{% for i in range(count) if count > 0 %}{% set _ = extra_disks.append({'size': max_size}) %}{% endfor %}{% if modulo > 0 %}{% set _ = extra_disks.append({'size': modulo }) %}{% endif %}{{ extra_disks | tojson }}, configure_job_template=linux_configuration, prime_user_description=VTB.Cloud, prime_user_init_passwd=JDYkbkttSFhCZVckOW9mZEoxMHYyaUxQUTl3R24zYkpaNy84Y0tPamF1R25KaU0va0JZUUEycXRIYy56aFFvZkRUQlhmSHBVeHZUbkYvUzFGNnVrclVScXpQRDVtSFlsUDA=}}]